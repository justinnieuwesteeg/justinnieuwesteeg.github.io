<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>South Padre Live</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        /* Apply base styles to the body for font, background, and text color */
        body {
            font-family: 'Inter', sans-serif;
            @apply bg-gray-100 text-gray-800;
        }
        /* Styles for the tab container */
        .tab-container {
            @apply bg-white;
        }
        /* Individual tab styles */
        .tab {
            @apply text-gray-600 flex-shrink-0; /* flex-shrink-0 prevents tabs from shrinking on small screens */
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 4px solid transparent; /* Base underline, transparent by default */
            font-weight: 600;
            white-space: nowrap;
            transition: color 0.2s, border-color 0.2s;
        }
        /* Active tab style - Plain CSS for reliability */
        .tab.active {
            color: black;
            border-bottom-color: black;
            font-weight: 700; /* Corresponds to font-bold */
        }
        /* Style for list items */
        .list-item {
            @apply bg-white;
        }
        /* Style for expanded list items */
        .list-item.expanded {
            @apply bg-blue-50;
        }
        /* Sidebar styles */
        #sidebar {
            transition: transform 0.3s ease-in-out;
            background-color: white; /* Solid background color */
        }
        /* Logo text color */
        .logo-text {
            @apply fill-gray-700;
        }
        /* Utility to hide scrollbars */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
    </style>
</head>
<body class="antialiased">

    <!-- Sidebar Navigation -->
    <div id="sidebar" class="fixed top-0 left-0 h-full w-64 shadow-lg z-40 transform -translate-x-full">
        <!-- Sidebar Header -->
        <div class="p-5 border-b border-gray-200 relative">
             <button id="close-sidebar-btn" class="absolute top-3 right-3 p-2 rounded-full hover:bg-gray-200 transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            <div class="flex justify-center pt-4 pb-2">
                <img src="https://raw.githubusercontent.com/justinnieuwesteeg/South-Padre-Live/14de6e1468c550b4f41bd844a7a2d4efcf31ee79/Gemini_Generated_Image_hr4njehr4njehr4n%20(1).png" alt="South Padre Live Logo" class="w-56 object-contain">
            </div>
        </div>
        <!-- Sidebar Links -->
        <nav id="sidebar-nav" class="mt-5 p-2">
            <a href="#home" class="flex items-center py-2.5 px-4 rounded transition duration-200 hover:bg-blue-100 text-gray-700 font-semibold">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>Home
            </a>
            <a href="#submit" class="flex items-center py-2.5 px-4 rounded transition duration-200 hover:bg-blue-100 text-gray-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>Submit a Special
            </a>
            <a href="#contact" class="flex items-center py-2.5 px-4 rounded transition duration-200 hover:bg-blue-100 text-gray-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>Contact Us
            </a>
            <a href="#settings" class="flex items-center py-2.5 px-4 rounded transition duration-200 hover:bg-blue-100 text-gray-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924-1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0 3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>Settings
            </a>
        </nav>
    </div>

    <!-- Header Section -->
    <header id="header" class="bg-black text-white p-4 text-center shadow-md sticky top-0 z-20 flex items-center justify-between">
        <!-- Menu Button -->
        <button id="menu-btn" class="p-2 rounded-md hover:bg-gray-700 transition">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
        </button>
        
        <!-- Logo -->
        <div class="flex justify-center h-20 flex-grow">
             <img src="https://raw.githubusercontent.com/justinnieuwesteeg/South-Padre-Live/366f7cc9b0015210b4cfbe291cd35ade07de20e5/NEON%20LOGO%20CUT.PNG" alt="South Padre Live Logo" class="h-full object-contain">
        </div>
        <div class="w-10 h-10"></div> <!-- Spacer to balance the menu button -->
    </header>

    <div id="page-container">
        <!-- Main Content (Specials List) -->
        <main id="home-page">
            <div id="tab-bar" class="bg-white shadow-md sticky z-10">
                <div id="tab-container" class="flex overflow-x-auto sm:justify-center no-scrollbar"></div>
            </div>
            <div class="p-4 sm:p-6 md:p-8">
                <div id="specials-list" class="flex flex-col gap-3">
                    <!-- Specials list items will be dynamically inserted here -->
                </div>
            </div>
        </main>

        <!-- Settings Page -->
        <div id="settings-page" class="p-4 sm:p-6 md:p-8 hidden">
            <h1 class="text-3xl font-bold text-gray-800 mb-8">Settings</h1>
            <div class="space-y-8 bg-white p-6 rounded-lg shadow">
                 <p class="text-gray-600">App settings and preferences will be available here in a future update.</p>
            </div>
        </div>

        <!-- Submit a Special Page -->
        <div id="submit-page" class="p-4 sm:p-6 md:p-8 hidden">
            <h1 class="text-3xl font-bold text-gray-800 mb-4">Submit a Special</h1>
            <p class="text-sm text-gray-600 mb-8">
                To adjust or request removal of an existing special please notate in the Special Details what change is requested or please feel free to send us an email at southpadrespecials@gmail.com
            </p>
            <form id="submit-form" class="space-y-6 bg-white p-6 rounded-lg shadow">
                <div>
                    <label for="business-name" class="block text-sm font-medium text-gray-700">Business Name</label>
                    <input type="text" id="business-name" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="location" class="block text-sm font-medium text-gray-700">Location / Address</label>
                    <input type="text" id="location" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Days of the Week</label>
                    <div id="day-checkboxes" class="mt-2 grid grid-cols-2 sm:grid-cols-4 gap-4">
                        <!-- Checkboxes will be inserted here by JavaScript -->
                    </div>
                </div>
                <div>
                    <label for="hours" class="block text-sm font-medium text-gray-700">Hours of Special (e.g., 4 PM - 7 PM)</label>
                    <input type="text" id="hours" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="special-details" class="block text-sm font-medium text-gray-700">Special Details</label>
                    <textarea id="special-details" rows="4" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>
                <div>
                    <button id="submit-button" type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg transition flex items-center justify-center">
                        Submit for Review
                    </button>
                </div>
            </form>
        </div>
        
        <!-- Contact Us Page -->
        <div id="contact-page" class="p-4 sm:p-6 md:p-8 hidden">
            <h1 class="text-3xl font-bold text-gray-800 mb-8">Contact & About Us</h1>
            <div class="space-y-12">
                <!-- About Us Section -->
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-2xl font-semibold text-gray-700 mb-4">About South Padre Live</h2>
                    <p class="text-gray-600 leading-relaxed">
                        Welcome to South Padre Live, your number one source for the best food and drink specials on the island! Our mission is to connect locals and visitors with the amazing deals our local restaurants and bars have to offer, every single day of the week. We are a small team passionate about supporting local businesses and helping you make the most of your time on SPI.
                    </p>
                </div>
                <!-- Contact Information Section -->
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-2xl font-semibold text-gray-700 mb-4">Get in Touch</h2>
                    <p class="text-gray-600 mb-4">Have a question, a suggestion, or just want to say hello? We'd love to hear from you!</p>
                    <ul class="space-y-3">
                        <li class="flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg><a href="mailto:southpadrespecials@gmail.com" class="text-blue-600 hover:underline">southpadrespecials@gmail.com</a></li>
                    </ul>
                </div>
                <!-- Advertising Section -->
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-2xl font-semibold text-gray-700 mb-4">Advertising Opportunities</h2>
                    <p class="text-gray-600 leading-relaxed">
                        Are you a local business owner looking to reach thousands of hungry and thirsty island-goers? We offer featured listings and promotional packages to help your specials stand out. Partner with us to drive more foot traffic through your doors. For more information on our advertising rates and packages, please email us at <a href="mailto:southpadrespecials@gmail.com" class="text-blue-600 hover:underline">southpadrespecials@gmail.com</a>.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Disclaimer Footer -->
    <footer class="text-center p-6 mt-8">
        <p class="text-xs text-gray-500">
            Accuracy of listed offers not guaranteed. Please contact the establishment to confirm validity of the offer.
        </p>
    </footer>
    
    <!-- Submission Confirmation Modal -->
    <div id="confirmation-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
      <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
          <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100">
            <svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
          </div>
          <h3 class="text-lg leading-6 font-medium text-gray-900 mt-2">Submission Received!</h3>
          <div class="mt-2 px-7 py-3">
            <p class="text-sm text-gray-500">
              Thank you for your submission! We will review it and add it to our listings if applicable.
            </p>
          </div>
          <div class="items-center px-4 py-3">
            <button id="ok-btn" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300">
              OK
            </button>
          </div>
        </div>
      </div>
    </div>


    <script>
        // --- Live Google Sheet URLs for each day's specials ---
        const googleSheetUrls = {
            "Sunday": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQEOyBKBeFcFFxe6KUxPz4h2HuUGKagHsHmMiFzm-M6ummkSd71O-1HBMEvKZ6zmZYAOPdzS8HL2dyd/pub?gid=0&single=true&output=csv",
            "Monday": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQEOyBKBeFcFFxe6KUxPz4h2HuUGKagHsHmMiFzm-M6ummkSd71O-1HBMEvKZ6zmZYAOPdzS8HL2dyd/pub?gid=1257750835&single=true&output=csv",
            "Tuesday": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQEOyBKBeFcFFxe6KUxPz4h2HuUGKagHsHmMiFzm-M6ummkSd71O-1HBMEvKZ6zmZYAOPdzS8HL2dyd/pub?gid=1702948833&single=true&output=csv",
            "Wednesday": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQEOyBKBeFcFFxe6KUxPz4h2HuUGKagHsHmMiFzm-M6ummkSd71O-1HBMEvKZ6zmZYAOPdzS8HL2dyd/pub?gid=343066187&single=true&output=csv",
            "Thursday": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQEOyBKBeFcFFxe6KUxPz4h2HuUGKagHsHmMiFzm-M6ummkSd71O-1HBMEvKZ6zmZYAOPdzS8HL2dyd/pub?gid=393692940&single=true&output=csv",
            "Friday": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQEOyBKBeFcFFxe6KUxPz4h2HuUGKagHsHmMiFzm-M6ummkSd71O-1HBMEvKZ6zmZYAOPdzS8HL2dyd/pub?gid=406940710&single=true&output=csv",
            "Saturday": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQEOyBKBeFcFFxe6KUxPz4h2HuUGKagHsHmMiFzm-M6ummkSd71O-1HBMEvKZ6zmZYAOPdzS8HL2dyd/pub?gid=981161527&single=true&output=csv"
        };
        const submissionUrl = "https://script.google.com/macros/s/AKfycbyj6AHMyFwR16dGBqNoczaSQ2phFMVngTgP9-nQy11QL2xuCs2utK2Z2q6R6F1dWiPm7w/exec";

        // --- DOM Element References & State ---
        const listContainer = document.getElementById('specials-list');
        const tabContainer = document.getElementById('tab-container');
        const daysOfWeek = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
        const sidebar = document.getElementById('sidebar');
        const menuBtn = document.getElementById('menu-btn');
        const closeSidebarBtn = document.getElementById('close-sidebar-btn');
        const homePage = document.getElementById('home-page');
        const settingsPage = document.getElementById('settings-page');
        const submitPage = document.getElementById('submit-page');
        const contactPage = document.getElementById('contact-page');
        const sidebarNav = document.getElementById('sidebar-nav');
        const submitForm = document.getElementById('submit-form');
        const header = document.getElementById('header');
        const tabBar = document.getElementById('tab-bar');
        const dayCheckboxesContainer = document.getElementById('day-checkboxes');
        const confirmationModal = document.getElementById('confirmation-modal');
        const okBtn = document.getElementById('ok-btn');
        
        let currentDay = '';
        let allSpecialsData = {};
        let isDataLoaded = false;

        // --- Sidebar & Page Navigation Logic ---
        function toggleSidebar() {
            sidebar.classList.toggle('-translate-x-full');
        }

        function showPage(pageId) {
            [homePage, settingsPage, submitPage, contactPage].forEach(page => {
                page.classList.toggle('hidden', page.id !== pageId);
            });
            if (!sidebar.classList.contains('-translate-x-full')) {
                toggleSidebar();
            }
        }

        menuBtn.addEventListener('click', toggleSidebar);
        closeSidebarBtn.addEventListener('click', toggleSidebar);
        
        sidebarNav.addEventListener('click', (e) => {
            e.preventDefault();
            const link = e.target.closest('a');
            if (!link) return;
            const targetId = link.getAttribute('href').substring(1);
            const pageMap = { 'home': 'home-page', 'settings': 'settings-page', 'submit': 'submit-page', 'contact': 'contact-page' };
            if (pageMap[targetId]) showPage(pageMap[targetId]);
        });

        // --- Data Fetching & Caching ---
        
        function parseCSV(csvText) {
            const rows = [];
            let currentRow = [];
            let currentCell = '';
            let inQuotes = false;

            for (let i = 0; i < csvText.length; i++) {
                const char = csvText[i];

                if (char === '"') {
                    if (inQuotes && csvText[i + 1] === '"') {
                        currentCell += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    currentRow.push(currentCell.trim());
                    currentCell = '';
                } else if ((char === '\n' || char === '\r') && !inQuotes) {
                    if (csvText[i + 1] === '\n' || csvText[i + 1] === '\r') {
                        i++;
                    }
                    currentRow.push(currentCell.trim());
                    rows.push(currentRow);
                    currentRow = [];
                    currentCell = '';
                } else {
                    currentCell += char;
                }
            }
            if (currentCell || currentRow.length > 0) {
                 currentRow.push(currentCell.trim());
                 rows.push(currentRow);
            }
            return rows;
        }


        async function fetchAllDataInBackground() {
            // This function fetches data for all days in the background
            // to populate the weekly specials expansion feature, without blocking the UI.
            const fetchPromises = daysOfWeek.map(async (day) => {
                // If data for the day already exists (from being clicked), don't re-fetch it.
                if (allSpecialsData[day]) return;

                try {
                    const url = googleSheetUrls[day];
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`Failed to fetch ${day}`);
                    const csvText = await response.text();
                    
                    const rows = parseCSV(csvText);
                    const specials = rows.slice(1)
                                        .map((parts, index) => {
                                            if (parts.length < 4) return null;
                                            const [name, location, hours, special, website, phone] = parts;
                                            if (!name && !location && !special) return null;
                                            return { id: `${day}-${index}`, name, location, hours, special, day, website, phone };
                                        }).filter(Boolean);

                    allSpecialsData[day] = specials;
                } catch (error) {
                    console.error(`Error fetching background data for ${day}:`, error);
                    allSpecialsData[day] = []; // Ensure day exists to prevent future fetches
                }
            });
            await Promise.all(fetchPromises);
            isDataLoaded = true;
        }

        async function refreshAndRenderDay(day) {
            currentDay = day;
            listContainer.innerHTML = `<p class="text-center text-gray-500 mt-8">Loading specials for ${day}...</p>`;
            document.querySelectorAll('#tab-container .tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.day === currentDay);
            });

            try {
                const url = googleSheetUrls[day];
                const response = await fetch(url);
                if (!response.ok) throw new Error('Network response was not ok');
                const csvText = await response.text();
                const rows = parseCSV(csvText);
                const specials = rows.slice(1)
                    .map((parts, index) => {
                        if (parts.length < 4) return null;
                        const [name, location, hours, special, website, phone] = parts;
                        if (!name && !location && !special) return null;
                        return { id: `${day}-${index}`, name, location, hours, special, day, website, phone };
                    }).filter(Boolean);

                // Update the central data cache and render the list
                allSpecialsData[day] = specials;
                renderSpecials(specials);

            } catch (error) {
                console.error(`Failed to fetch specials for ${day}:`, error);
                listContainer.innerHTML = `<p class="text-center text-red-500 mt-8">Could not load specials. Please try again later.</p>`;
            }
        }

        // --- UI Rendering ---

        function renderSpecialsForDay(day) {
            // This function is now a simple wrapper to call the refresh function.
            refreshAndRenderDay(day);
        }

        function renderSpecials(specials) {
            listContainer.innerHTML = '';
            if (specials.length === 0) {
                listContainer.innerHTML = `<p class="text-center text-gray-500 mt-8">No specials listed for ${currentDay}. Check back soon!</p>`;
                return;
            }

            specials.forEach(special => {
                const listItem = document.createElement('div');
                listItem.className = 'list-item grid grid-cols-1 md:grid-cols-12 gap-x-4 gap-y-2 items-center p-4 rounded-lg shadow cursor-pointer hover:bg-gray-50 transition';
                
                let websiteUrl = special.website;
                let phoneNumber = special.phone;
                let iconsHTML = '';

                if (websiteUrl) {
                    if (!websiteUrl.startsWith('http://') && !websiteUrl.startsWith('https://')) {
                        websiteUrl = 'https://' + websiteUrl;
                    }
                    iconsHTML += `
                        <a href="${websiteUrl}" target="_blank" rel="noopener noreferrer" class="ml-2 text-blue-500 hover:text-blue-700 transition-colors" title="Visit Website" onclick="event.stopPropagation()">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                            </svg>
                        </a>`;
                }

                if (phoneNumber) {
                    iconsHTML += `
                        <a href="tel:${phoneNumber}" class="ml-2 text-gray-600 hover:text-blue-700 transition-colors" title="Call ${phoneNumber}" onclick="event.stopPropagation()">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                            </svg>
                        </a>`;
                }

                listItem.innerHTML = `
                    <div class="md:col-span-3 font-bold text-lg text-black flex items-center justify-between">
                        <span>${special.name || ''}</span>
                        <div class="flex items-center">${iconsHTML}</div>
                    </div>
                    <div class="md:col-span-3 text-sm text-black">
                        <div>${special.location || ''}</div>
                        ${special.phone ? `<div class="mt-1 text-gray-600">${special.phone}</div>` : ''}
                    </div>
                    <div class="md:col-span-2 text-sm text-black">${special.hours || ''}</div>
                    <div class="md:col-span-4 text-sm text-black whitespace-pre-wrap">${special.special || ''}</div>
                `;
                listItem.addEventListener('click', () => toggleSpecialExpansion(listItem, special.name));
                listContainer.appendChild(listItem);
            });

            document.querySelectorAll('#tab-container .tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.day === currentDay);
            });
        }

        function renderTabs() {
            daysOfWeek.forEach(day => {
                const tab = document.createElement('div');
                tab.className = 'tab';
                tab.dataset.day = day;
                tab.innerText = day;
                tab.onclick = () => refreshAndRenderDay(day);
                tabContainer.appendChild(tab);
            });
        }

        // --- Interactive Features ---

        function closeAllExpansions() {
            document.querySelectorAll('.expansion-panel').forEach(panel => panel.remove());
            document.querySelectorAll('.list-item.expanded').forEach(item => item.classList.remove('expanded'));
        }

        function toggleSpecialExpansion(clickedItem, businessName) {
            const isAlreadyExpanded = clickedItem.classList.contains('expanded');
            closeAllExpansions();

            if (isAlreadyExpanded) return;

            clickedItem.classList.add('expanded');
            const expansionPanel = document.createElement('div');
            expansionPanel.className = 'expansion-panel bg-gray-50 p-4 ml-0 md:ml-4 my-2 border-l-4 border-blue-500 rounded-r-lg';
            
            const businessSpecial = Object.values(allSpecialsData).flat().find(s => s.name === businessName);
            
            let contentHTML = `
                <div class="flex items-center mb-2">
                    <h4 class="font-bold text-md text-gray-800">All Weekly Specials for ${businessName}:</h4>
                </div>`;

            contentHTML += `<div class="space-y-3">`;
            let foundAny = false;

            daysOfWeek.forEach(day => {
                const specialsForDay = allSpecialsData[day].filter(s => s.name === businessName);
                if (specialsForDay.length > 0) {
                    foundAny = true;
                    contentHTML += `<div><p class="font-semibold text-sm text-blue-600">${day}</p>`;
                    specialsForDay.forEach(s => {
                        contentHTML += `<div class="text-sm text-gray-700 pl-2 whitespace-pre-wrap">${s.hours}: ${s.special}</div>`;
                    });
                    contentHTML += `</div>`;
                }
            });

            contentHTML += '</div>';
            if (!foundAny) contentHTML = `<p class="text-sm text-gray-600">No other specials found for ${businessName} this week.</p>`;
            
            expansionPanel.innerHTML = contentHTML;
            clickedItem.insertAdjacentElement('afterend', expansionPanel);
        }

        // --- Form Submission Logic ---
        submitForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitButton = document.getElementById('submit-button');
            submitButton.disabled = true;
            submitButton.innerHTML = 'Submitting...';
            const selectedDays = Array.from(document.querySelectorAll('input[name="days"]:checked')).map(cb => cb.value);

            if (selectedDays.length === 0) {
                alert('Please select at least one day of the week.');
                submitButton.disabled = false;
                submitButton.innerHTML = 'Submit for Review';
                return;
            }

            const formData = {
                businessName: document.getElementById('business-name').value,
                location: document.getElementById('location').value,
                days: selectedDays.join(', '),
                hours: document.getElementById('hours').value,
                specialDetails: document.getElementById('special-details').value,
            };

            try {
                // The new URL should handle both writing to the sheet and sending the email.
                await fetch(submissionUrl, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(formData) });
                
                confirmationModal.classList.remove('hidden');
                submitForm.reset();
            } catch (error) {
                console.error('Submission error:', error);
                alert('An error occurred during submission. Please try again.');
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = 'Submit for Review';
            }
        });
        
        okBtn.addEventListener('click', () => {
            confirmationModal.classList.add('hidden');
        });
        
        // --- App Initialization ---
        function adjustLayout() {
            const headerHeight = header.offsetHeight;
            tabBar.style.top = `${headerHeight}px`;
        }

        async function initializeApp() {
            daysOfWeek.forEach(day => {
                const label = document.createElement('label');
                label.className = 'flex items-center space-x-2 text-sm text-gray-700';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.name = 'days';
                checkbox.value = day;
                checkbox.className = 'h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500';
                label.appendChild(checkbox);
                label.appendChild(document.createTextNode(day));
                dayCheckboxesContainer.appendChild(label);
            });

            renderTabs();
            
            // Initial Load: Fetch today's data immediately, then fetch the rest in the background.
            const todayIndex = new Date().getDay();
            const todayName = daysOfWeek[todayIndex];
            refreshAndRenderDay(todayName); // Show today's specials ASAP
            fetchAllDataInBackground(); // Load other days for the expansion feature
            
            adjustLayout();
            window.addEventListener('resize', adjustLayout);
        }

        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>

</body>
</html>

